<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº¦å…‹é£åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #console {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .volume-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .volume-level {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤ éº¦å…‹é£åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>

    <div class="test-section">
        <h2>ğŸ” æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹</h2>
        <div id="browser-info"></div>
        <div id="api-support"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¤ éº¦å…‹é£æƒé™æµ‹è¯•</h2>
        <button onclick="testMicrophonePermission()">æµ‹è¯•éº¦å…‹é£æƒé™</button>
        <div id="mic-status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”Š éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•</h2>
        <button onclick="testAudioContext()">æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡</button>
        <div id="audio-context-status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“¡ éŸ³é¢‘é‡‡é›†æµ‹è¯•</h2>
        <button onclick="startVoiceTest()" id="voiceTestBtn">å¼€å§‹éŸ³é¢‘é‡‡é›†æµ‹è¯•</button>
        <div id="voice-test-status"></div>
        <div class="volume-bar">
            <div class="volume-level" id="volumeLevel"></div>
        </div>
        <div id="audio-data-info"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ è°ƒè¯•æ§åˆ¶å°</h2>
        <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
        <div id="console"></div>
    </div>

    <script>
        let isVoiceTestActive = false;
        let audioContext = null;
        let mediaStream = null;
        let audioProcessor = null;
        let lastVolumeUpdate = 0;

        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d';
            logEntry.textContent = `[${timestamp}] ${message}`;
            console.appendChild(logEntry);
            console.scrollTop = console.scrollHeight;

            // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            window.console.log(`[éº¦å…‹é£æµ‹è¯•] ${message}`);
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // æ£€æµ‹æµè§ˆå™¨ä¿¡æ¯
        function detectBrowserInfo() {
            const userAgent = navigator.userAgent;
            const isChrome = /Chrome/.test(userAgent) && /Google Inc/.test(navigator.vendor);
            const chromeVersion = userAgent.match(/Chrome\/(\d+)/);

            let browserInfo = `æµè§ˆå™¨: ${navigator.userAgent}<br>`;
            browserInfo += `Chrome: ${isChrome ? 'æ˜¯' : 'å¦'}<br>`;
            if (chromeVersion) {
                browserInfo += `Chromeç‰ˆæœ¬: ${chromeVersion[1]}<br>`;
            }
            browserInfo += `å¹³å°: ${navigator.platform}<br>`;
            browserInfo += `è¯­è¨€: ${navigator.language}<br>`;

            document.getElementById('browser-info').innerHTML = browserInfo;

            if (isChrome && chromeVersion && parseInt(chromeVersion[1]) >= 80) {
                log('âœ… Chromeæµè§ˆå™¨ç‰ˆæœ¬å…¼å®¹', 'success');
            } else {
                log('âš ï¸ å»ºè®®ä½¿ç”¨Chrome 80+ç‰ˆæœ¬', 'warning');
            }
        }

        // æ£€æµ‹APIæ”¯æŒ
        function detectAPISupport() {
            let apiInfo = '';
            let allSupported = true;

            // æ£€æµ‹ getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                apiInfo += '<div class="status success">âœ… getUserMedia API: æ”¯æŒ</div>';
                log('âœ… getUserMedia API æ”¯æŒ', 'success');
            } else {
                apiInfo += '<div class="status error">âŒ getUserMedia API: ä¸æ”¯æŒ</div>';
                log('âŒ getUserMedia API ä¸æ”¯æŒ', 'error');
                allSupported = false;
            }

            // æ£€æµ‹ Web Audio API
            if (window.AudioContext || window.webkitAudioContext) {
                apiInfo += '<div class="status success">âœ… Web Audio API: æ”¯æŒ</div>';
                log('âœ… Web Audio API æ”¯æŒ', 'success');
            } else {
                apiInfo += '<div class="status error">âŒ Web Audio API: ä¸æ”¯æŒ</div>';
                log('âŒ Web Audio API ä¸æ”¯æŒ', 'error');
                allSupported = false;
            }

            // æ£€æµ‹ AudioWorklet
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (AudioContextClass) {
                const tempContext = new AudioContextClass();
                if (tempContext.audioWorklet) {
                    apiInfo += '<div class="status success">âœ… AudioWorklet: æ”¯æŒ</div>';
                    log('âœ… AudioWorklet æ”¯æŒï¼ˆæ¨èï¼‰', 'success');
                } else {
                    apiInfo += '<div class="status warning">âš ï¸ AudioWorklet: ä¸æ”¯æŒï¼Œå°†ä½¿ç”¨ScriptProcessor</div>';
                    log('âš ï¸ AudioWorklet ä¸æ”¯æŒï¼Œå°†ä½¿ç”¨ScriptProcessor', 'warning');
                }
                tempContext.close();
            }

            // æ£€æµ‹ createScriptProcessor
            if (AudioContextClass) {
                const tempContext = new AudioContextClass();
                if (tempContext.createScriptProcessor) {
                    apiInfo += '<div class="status success">âœ… ScriptProcessor: æ”¯æŒ</div>';
                    log('âœ… ScriptProcessor æ”¯æŒ', 'success');
                } else {
                    apiInfo += '<div class="status error">âŒ ScriptProcessor: ä¸æ”¯æŒ</div>';
                    log('âŒ ScriptProcessor ä¸æ”¯æŒ', 'error');
                    allSupported = false;
                }
                tempContext.close();
            }

            document.getElementById('api-support').innerHTML = apiInfo;
            return allSupported;
        }

        // æµ‹è¯•éº¦å…‹é£æƒé™
        async function testMicrophonePermission() {
            setStatus('mic-status', 'æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');
            log('å¼€å§‹æµ‹è¯•éº¦å…‹é£æƒé™...');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // æ£€æŸ¥éŸ³é¢‘è½¨é“
                const audioTracks = stream.getAudioTracks();
                log(`âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼ŒéŸ³é¢‘è½¨é“æ•°é‡: ${audioTracks.length}`, 'success');

                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    log(`éŸ³é¢‘è½¨é“ä¿¡æ¯: ${track.label || 'æœªå‘½åè®¾å¤‡'}`, 'info');
                    log(`éŸ³é¢‘è½¨é“çŠ¶æ€: ${track.readyState}`, 'info');
                    log(`éŸ³é¢‘è½¨é“è®¾ç½®: ${JSON.stringify(track.getSettings())}`, 'info');
                }

                setStatus('mic-status', 'âœ… éº¦å…‹é£æƒé™æµ‹è¯•é€šè¿‡', 'success');

                // å…³é—­æµ
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                log(`âŒ éº¦å…‹é£æƒé™æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                setStatus('mic-status', `âŒ éº¦å…‹é£æƒé™æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');

                if (error.name === 'NotAllowedError') {
                    setStatus('mic-status', 'âŒ ç”¨æˆ·æ‹’ç»äº†éº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®', 'error');
                } else if (error.name === 'NotFoundError') {
                    setStatus('mic-status', 'âŒ æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ç¡¬ä»¶è¿æ¥', 'error');
                }
            }
        }

        // æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡
        function testAudioContext() {
            setStatus('audio-context-status', 'æ­£åœ¨æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡...', 'info');
            log('å¼€å§‹æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡...');

            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContextClass();

                log(`âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºæˆåŠŸ`, 'success');
                log(`éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€: ${audioContext.state}`, 'info');
                log(`é‡‡æ ·ç‡: ${audioContext.sampleRate}Hz`, 'info');
                log(`æœ€å¤§é€šé“æ•°: ${audioContext.destination.maxChannelCount}`, 'info');

                if (audioContext.state === 'suspended') {
                    log('éŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œå°è¯•æ¢å¤...', 'warning');
                    audioContext.resume().then(() => {
                        log('âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡æ¢å¤æˆåŠŸ', 'success');
                        setStatus('audio-context-status', 'âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•é€šè¿‡', 'success');
                    }).catch(error => {
                        log(`âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æ¢å¤å¤±è´¥: ${error.message}`, 'error');
                        setStatus('audio-context-status', `âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æ¢å¤å¤±è´¥: ${error.message}`, 'error');
                    });
                } else {
                    setStatus('audio-context-status', 'âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•é€šè¿‡', 'success');
                }

            } catch (error) {
                log(`âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                setStatus('audio-context-status', `âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹éŸ³é¢‘é‡‡é›†æµ‹è¯•
        async function startVoiceTest() {
            if (isVoiceTestActive) {
                stopVoiceTest();
                return;
            }

            const btn = document.getElementById('voiceTestBtn');
            btn.textContent = 'åœæ­¢æµ‹è¯•';
            isVoiceTestActive = true;

            setStatus('voice-test-status', 'æ­£åœ¨å¯åŠ¨éŸ³é¢‘é‡‡é›†æµ‹è¯•...', 'info');
            log('å¼€å§‹éŸ³é¢‘é‡‡é›†æµ‹è¯•...');

            try {
                // è·å–éº¦å…‹é£æµ
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 44100
                    }
                });

                log('âœ… åª’ä½“æµè·å–æˆåŠŸ', 'success');

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                if (!audioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContextClass();
                }

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // åˆ›å»ºéŸ³é¢‘æº
                const source = audioContext.createMediaStreamSource(mediaStream);
                log('âœ… éŸ³é¢‘æºåˆ›å»ºæˆåŠŸ', 'success');

                // å°è¯•ä½¿ç”¨ AudioWorklet
                if (audioContext.audioWorklet) {
                    log('å°è¯•ä½¿ç”¨ AudioWorklet...', 'info');
                    try {
                        await setupAudioWorklet(source);
                    } catch (error) {
                        log(`AudioWorkletå¤±è´¥ï¼Œä½¿ç”¨ScriptProcessor: ${error.message}`, 'warning');
                        setupScriptProcessor(source);
                    }
                } else {
                    log('AudioWorkletä¸æ”¯æŒï¼Œä½¿ç”¨ScriptProcessor', 'warning');
                    setupScriptProcessor(source);
                }

                setStatus('voice-test-status', 'âœ… éŸ³é¢‘é‡‡é›†æµ‹è¯•è¿è¡Œä¸­ï¼Œè¯·å¯¹ç€éº¦å…‹é£è¯´è¯', 'success');

            } catch (error) {
                log(`âŒ éŸ³é¢‘é‡‡é›†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                setStatus('voice-test-status', `âŒ éŸ³é¢‘é‡‡é›†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                stopVoiceTest();
            }
        }

        // è®¾ç½® AudioWorklet
        async function setupAudioWorklet(source) {
            const processorCode = `
                class VoiceTestProcessor extends AudioWorkletProcessor {
                    constructor() {
                        super();
                        this._lastUpdate = 0;
                    }

                    process(inputs, outputs, parameters) {
                        const input = inputs[0];
                        if (input.length > 0) {
                            const inputData = input[0];
                            let maxAmplitude = 0;
                            for (let i = 0; i < inputData.length; i++) {
                                const amplitude = Math.abs(inputData[i]);
                                if (amplitude > maxAmplitude) {
                                    maxAmplitude = amplitude;
                                }
                            }

                            // é™åˆ¶æ¶ˆæ¯å‘é€é¢‘ç‡
                            const now = currentTime;
                            if (now - this._lastUpdate > 0.1) { // çº¦100ms
                                this._lastUpdate = now;
                                this.port.postMessage({
                                    maxAmplitude: maxAmplitude,
                                    dataLength: inputData.length,
                                    hasAudio: maxAmplitude > 0.001
                                });
                            }
                        }
                        return true;
                    }
                }
                registerProcessor('voice-test-processor', VoiceTestProcessor);
            `;

            const blob = new Blob([processorCode], { type: 'application/javascript' });
            const processorUrl = URL.createObjectURL(blob);

            await audioContext.audioWorklet.addModule(processorUrl);
            audioProcessor = new AudioWorkletNode(audioContext, 'voice-test-processor');

            audioProcessor.port.onmessage = function(event) {
                if (!isVoiceTestActive) return;
                handleAudioData(event.data.maxAmplitude, event.data.dataLength, event.data.hasAudio);
            };

            source.connect(audioProcessor);
            audioProcessor.connect(audioContext.destination);
            log('âœ… AudioWorklet è®¾ç½®æˆåŠŸ', 'success');
        }

        // è®¾ç½® ScriptProcessor
        function setupScriptProcessor(source) {
            const bufferSize = 4096;
            audioProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            audioProcessor.onaudioprocess = function(event) {
                if (!isVoiceTestActive) return;

                const inputData = event.inputBuffer.getChannelData(0);
                let maxAmplitude = 0;
                for (let i = 0; i < inputData.length; i++) {
                    const amplitude = Math.abs(inputData[i]);
                    if (amplitude > maxAmplitude) {
                        maxAmplitude = amplitude;
                    }
                }

                const hasAudio = maxAmplitude > 0.001;
                handleAudioData(maxAmplitude, inputData.length, hasAudio);
            };

            source.connect(audioProcessor);
            audioProcessor.connect(audioContext.destination);
            log('âœ… ScriptProcessor è®¾ç½®æˆåŠŸ', 'success');

            // æ‰“å°æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
            log('âš ï¸ æ³¨æ„ï¼šScriptProcessorå·²è¢«åºŸå¼ƒï¼Œå¯èƒ½åœ¨æŸäº›æµè§ˆå™¨ä¸­ä¸å¯é ', 'warning');
            log('ğŸ“ è°ƒè¯•æç¤ºï¼šå¦‚æœæ²¡æœ‰å£°éŸ³æ£€æµ‹ï¼Œè¯·å°è¯•ç‚¹å‡»é¡µé¢æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡', 'info');
        }

        // å¤„ç†éŸ³é¢‘æ•°æ®
        function handleAudioData(maxAmplitude, dataLength, hasAudio) {
            const now = Date.now();

            // æ›´æ–°éŸ³é‡æ˜¾ç¤º
            const volumePercent = Math.min(maxAmplitude * 1000, 100); // æ”¾å¤§1000å€
            document.getElementById('volumeLevel').style.width = volumePercent + '%';

            // é™åˆ¶æ—¥å¿—è¾“å‡ºé¢‘ç‡
            if (now - lastVolumeUpdate > 200) { // æ¯200msæ›´æ–°ä¸€æ¬¡
                lastVolumeUpdate = now;

                // åªåœ¨æœ‰æ•ˆéŸ³é¢‘æ—¶è¾“å‡ºæ—¥å¿—
                if (hasAudio) {
                    log(`ğŸ¤ éŸ³é¢‘æ£€æµ‹ - æŒ¯å¹…: ${maxAmplitude.toFixed(6)}, æ•°æ®é•¿åº¦: ${dataLength}, æœ‰æ•ˆéŸ³é¢‘: ${hasAudio}`, 'success');

                    // æ¨¡æ‹Ÿå‘é€æ•°æ®
                    const audioData = new Int16Array(dataLength);
                    for (let i = 0; i < dataLength; i++) {
                        audioData[i] = Math.random() * 32767; // æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®
                    }
                    const audioBytes = new Uint8Array(audioData.buffer);
                    const audioHex = Array.from(audioBytes).map(b => b.toString(16).padStart(2, '0')).join('');

                    document.getElementById('audio-data-info').innerHTML =
                        `<div class="status info">
                            æœ€æ–°éŸ³é¢‘æ•°æ®:<br>
                            æ ·æœ¬æ•°: ${audioData.length}<br>
                            å­—èŠ‚æ•°: ${audioBytes.length}<br>
                            åå…­è¿›åˆ¶é•¿åº¦: ${audioHex.length}<br>
                            æœ€å¤§æŒ¯å¹…: ${maxAmplitude.toFixed(6)}
                        </div>`;

                    log(`ğŸ“¡ æ¨¡æ‹Ÿå‘é€æ•°æ® - æ ·æœ¬: ${audioData.length}, å­—èŠ‚: ${audioBytes.length}`, 'info');
                }
            }
        }

        // åœæ­¢éŸ³é¢‘æµ‹è¯•
        function stopVoiceTest() {
            isVoiceTestActive = false;
            const btn = document.getElementById('voiceTestBtn');
            btn.textContent = 'å¼€å§‹éŸ³é¢‘é‡‡é›†æµ‹è¯•';

            if (audioProcessor) {
                if (audioProcessor.disconnect) {
                    audioProcessor.disconnect();
                }
                audioProcessor = null;
            }

            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            document.getElementById('volumeLevel').style.width = '0%';
            setStatus('voice-test-status', 'éŸ³é¢‘é‡‡é›†æµ‹è¯•å·²åœæ­¢', 'info');
            log('éŸ³é¢‘é‡‡é›†æµ‹è¯•å·²åœæ­¢', 'info');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸ¤ éº¦å…‹é£è¯Šæ–­å·¥å…·å¯åŠ¨', 'success');
            detectBrowserInfo();
            detectAPISupport();
        };

        // é¡µé¢å…³é—­æ—¶æ¸…ç†èµ„æº
        window.onbeforeunload = function() {
            stopVoiceTest();
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
            }
        };
    </script>
</body>
</html>
