<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麦克风功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #console {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .volume-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .volume-level {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <h1>🎤 麦克风功能诊断工具</h1>

    <div class="test-section">
        <h2>🔍 浏览器兼容性检测</h2>
        <div id="browser-info"></div>
        <div id="api-support"></div>
    </div>

    <div class="test-section">
        <h2>🎤 麦克风权限测试</h2>
        <button onclick="testMicrophonePermission()">测试麦克风权限</button>
        <div id="mic-status"></div>
    </div>

    <div class="test-section">
        <h2>🔊 音频上下文测试</h2>
        <button onclick="testAudioContext()">测试音频上下文</button>
        <div id="audio-context-status"></div>
    </div>

    <div class="test-section">
        <h2>📡 音频采集测试</h2>
        <button onclick="startVoiceTest()" id="voiceTestBtn">开始音频采集测试</button>
        <div id="voice-test-status"></div>
        <div class="volume-bar">
            <div class="volume-level" id="volumeLevel"></div>
        </div>
        <div id="audio-data-info"></div>
    </div>

    <div class="test-section">
        <h2>📋 调试控制台</h2>
        <button onclick="clearConsole()">清空控制台</button>
        <div id="console"></div>
    </div>

    <script>
        let isVoiceTestActive = false;
        let audioContext = null;
        let mediaStream = null;
        let audioProcessor = null;
        let lastVolumeUpdate = 0;

        // 日志输出函数
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d';
            logEntry.textContent = `[${timestamp}] ${message}`;
            console.appendChild(logEntry);
            console.scrollTop = console.scrollHeight;

            // 同时输出到浏览器控制台
            window.console.log(`[麦克风测试] ${message}`);
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 检测浏览器信息
        function detectBrowserInfo() {
            const userAgent = navigator.userAgent;
            const isChrome = /Chrome/.test(userAgent) && /Google Inc/.test(navigator.vendor);
            const chromeVersion = userAgent.match(/Chrome\/(\d+)/);

            let browserInfo = `浏览器: ${navigator.userAgent}<br>`;
            browserInfo += `Chrome: ${isChrome ? '是' : '否'}<br>`;
            if (chromeVersion) {
                browserInfo += `Chrome版本: ${chromeVersion[1]}<br>`;
            }
            browserInfo += `平台: ${navigator.platform}<br>`;
            browserInfo += `语言: ${navigator.language}<br>`;

            document.getElementById('browser-info').innerHTML = browserInfo;

            if (isChrome && chromeVersion && parseInt(chromeVersion[1]) >= 80) {
                log('✅ Chrome浏览器版本兼容', 'success');
            } else {
                log('⚠️ 建议使用Chrome 80+版本', 'warning');
            }
        }

        // 检测API支持
        function detectAPISupport() {
            let apiInfo = '';
            let allSupported = true;

            // 检测 getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                apiInfo += '<div class="status success">✅ getUserMedia API: 支持</div>';
                log('✅ getUserMedia API 支持', 'success');
            } else {
                apiInfo += '<div class="status error">❌ getUserMedia API: 不支持</div>';
                log('❌ getUserMedia API 不支持', 'error');
                allSupported = false;
            }

            // 检测 Web Audio API
            if (window.AudioContext || window.webkitAudioContext) {
                apiInfo += '<div class="status success">✅ Web Audio API: 支持</div>';
                log('✅ Web Audio API 支持', 'success');
            } else {
                apiInfo += '<div class="status error">❌ Web Audio API: 不支持</div>';
                log('❌ Web Audio API 不支持', 'error');
                allSupported = false;
            }

            // 检测 AudioWorklet
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (AudioContextClass) {
                const tempContext = new AudioContextClass();
                if (tempContext.audioWorklet) {
                    apiInfo += '<div class="status success">✅ AudioWorklet: 支持</div>';
                    log('✅ AudioWorklet 支持（推荐）', 'success');
                } else {
                    apiInfo += '<div class="status warning">⚠️ AudioWorklet: 不支持，将使用ScriptProcessor</div>';
                    log('⚠️ AudioWorklet 不支持，将使用ScriptProcessor', 'warning');
                }
                tempContext.close();
            }

            // 检测 createScriptProcessor
            if (AudioContextClass) {
                const tempContext = new AudioContextClass();
                if (tempContext.createScriptProcessor) {
                    apiInfo += '<div class="status success">✅ ScriptProcessor: 支持</div>';
                    log('✅ ScriptProcessor 支持', 'success');
                } else {
                    apiInfo += '<div class="status error">❌ ScriptProcessor: 不支持</div>';
                    log('❌ ScriptProcessor 不支持', 'error');
                    allSupported = false;
                }
                tempContext.close();
            }

            document.getElementById('api-support').innerHTML = apiInfo;
            return allSupported;
        }

        // 测试麦克风权限
        async function testMicrophonePermission() {
            setStatus('mic-status', '正在请求麦克风权限...', 'info');
            log('开始测试麦克风权限...');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // 检查音频轨道
                const audioTracks = stream.getAudioTracks();
                log(`✅ 麦克风权限获取成功，音频轨道数量: ${audioTracks.length}`, 'success');

                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    log(`音频轨道信息: ${track.label || '未命名设备'}`, 'info');
                    log(`音频轨道状态: ${track.readyState}`, 'info');
                    log(`音频轨道设置: ${JSON.stringify(track.getSettings())}`, 'info');
                }

                setStatus('mic-status', '✅ 麦克风权限测试通过', 'success');

                // 关闭流
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                log(`❌ 麦克风权限测试失败: ${error.message}`, 'error');
                setStatus('mic-status', `❌ 麦克风权限测试失败: ${error.message}`, 'error');

                if (error.name === 'NotAllowedError') {
                    setStatus('mic-status', '❌ 用户拒绝了麦克风权限，请在浏览器设置中允许麦克风访问', 'error');
                } else if (error.name === 'NotFoundError') {
                    setStatus('mic-status', '❌ 未找到麦克风设备，请检查硬件连接', 'error');
                }
            }
        }

        // 测试音频上下文
        function testAudioContext() {
            setStatus('audio-context-status', '正在测试音频上下文...', 'info');
            log('开始测试音频上下文...');

            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContextClass();

                log(`✅ 音频上下文创建成功`, 'success');
                log(`音频上下文状态: ${audioContext.state}`, 'info');
                log(`采样率: ${audioContext.sampleRate}Hz`, 'info');
                log(`最大通道数: ${audioContext.destination.maxChannelCount}`, 'info');

                if (audioContext.state === 'suspended') {
                    log('音频上下文被暂停，尝试恢复...', 'warning');
                    audioContext.resume().then(() => {
                        log('✅ 音频上下文恢复成功', 'success');
                        setStatus('audio-context-status', '✅ 音频上下文测试通过', 'success');
                    }).catch(error => {
                        log(`❌ 音频上下文恢复失败: ${error.message}`, 'error');
                        setStatus('audio-context-status', `❌ 音频上下文恢复失败: ${error.message}`, 'error');
                    });
                } else {
                    setStatus('audio-context-status', '✅ 音频上下文测试通过', 'success');
                }

            } catch (error) {
                log(`❌ 音频上下文测试失败: ${error.message}`, 'error');
                setStatus('audio-context-status', `❌ 音频上下文测试失败: ${error.message}`, 'error');
            }
        }

        // 开始音频采集测试
        async function startVoiceTest() {
            if (isVoiceTestActive) {
                stopVoiceTest();
                return;
            }

            const btn = document.getElementById('voiceTestBtn');
            btn.textContent = '停止测试';
            isVoiceTestActive = true;

            setStatus('voice-test-status', '正在启动音频采集测试...', 'info');
            log('开始音频采集测试...');

            try {
                // 获取麦克风流
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 44100
                    }
                });

                log('✅ 媒体流获取成功', 'success');

                // 创建音频上下文
                if (!audioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContextClass();
                }

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // 创建音频源
                const source = audioContext.createMediaStreamSource(mediaStream);
                log('✅ 音频源创建成功', 'success');

                // 尝试使用 AudioWorklet
                if (audioContext.audioWorklet) {
                    log('尝试使用 AudioWorklet...', 'info');
                    try {
                        await setupAudioWorklet(source);
                    } catch (error) {
                        log(`AudioWorklet失败，使用ScriptProcessor: ${error.message}`, 'warning');
                        setupScriptProcessor(source);
                    }
                } else {
                    log('AudioWorklet不支持，使用ScriptProcessor', 'warning');
                    setupScriptProcessor(source);
                }

                setStatus('voice-test-status', '✅ 音频采集测试运行中，请对着麦克风说话', 'success');

            } catch (error) {
                log(`❌ 音频采集测试失败: ${error.message}`, 'error');
                setStatus('voice-test-status', `❌ 音频采集测试失败: ${error.message}`, 'error');
                stopVoiceTest();
            }
        }

        // 设置 AudioWorklet
        async function setupAudioWorklet(source) {
            const processorCode = `
                class VoiceTestProcessor extends AudioWorkletProcessor {
                    constructor() {
                        super();
                        this._lastUpdate = 0;
                    }

                    process(inputs, outputs, parameters) {
                        const input = inputs[0];
                        if (input.length > 0) {
                            const inputData = input[0];
                            let maxAmplitude = 0;
                            for (let i = 0; i < inputData.length; i++) {
                                const amplitude = Math.abs(inputData[i]);
                                if (amplitude > maxAmplitude) {
                                    maxAmplitude = amplitude;
                                }
                            }

                            // 限制消息发送频率
                            const now = currentTime;
                            if (now - this._lastUpdate > 0.1) { // 约100ms
                                this._lastUpdate = now;
                                this.port.postMessage({
                                    maxAmplitude: maxAmplitude,
                                    dataLength: inputData.length,
                                    hasAudio: maxAmplitude > 0.001
                                });
                            }
                        }
                        return true;
                    }
                }
                registerProcessor('voice-test-processor', VoiceTestProcessor);
            `;

            const blob = new Blob([processorCode], { type: 'application/javascript' });
            const processorUrl = URL.createObjectURL(blob);

            await audioContext.audioWorklet.addModule(processorUrl);
            audioProcessor = new AudioWorkletNode(audioContext, 'voice-test-processor');

            audioProcessor.port.onmessage = function(event) {
                if (!isVoiceTestActive) return;
                handleAudioData(event.data.maxAmplitude, event.data.dataLength, event.data.hasAudio);
            };

            source.connect(audioProcessor);
            audioProcessor.connect(audioContext.destination);
            log('✅ AudioWorklet 设置成功', 'success');
        }

        // 设置 ScriptProcessor
        function setupScriptProcessor(source) {
            const bufferSize = 4096;
            audioProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            audioProcessor.onaudioprocess = function(event) {
                if (!isVoiceTestActive) return;

                const inputData = event.inputBuffer.getChannelData(0);
                let maxAmplitude = 0;
                for (let i = 0; i < inputData.length; i++) {
                    const amplitude = Math.abs(inputData[i]);
                    if (amplitude > maxAmplitude) {
                        maxAmplitude = amplitude;
                    }
                }

                const hasAudio = maxAmplitude > 0.001;
                handleAudioData(maxAmplitude, inputData.length, hasAudio);
            };

            source.connect(audioProcessor);
            audioProcessor.connect(audioContext.destination);
            log('✅ ScriptProcessor 设置成功', 'success');

            // 打印更详细的调试信息
            log('⚠️ 注意：ScriptProcessor已被废弃，可能在某些浏览器中不可靠', 'warning');
            log('📝 调试提示：如果没有声音检测，请尝试点击页面激活音频上下文', 'info');
        }

        // 处理音频数据
        function handleAudioData(maxAmplitude, dataLength, hasAudio) {
            const now = Date.now();

            // 更新音量显示
            const volumePercent = Math.min(maxAmplitude * 1000, 100); // 放大1000倍
            document.getElementById('volumeLevel').style.width = volumePercent + '%';

            // 限制日志输出频率
            if (now - lastVolumeUpdate > 200) { // 每200ms更新一次
                lastVolumeUpdate = now;

                // 只在有效音频时输出日志
                if (hasAudio) {
                    log(`🎤 音频检测 - 振幅: ${maxAmplitude.toFixed(6)}, 数据长度: ${dataLength}, 有效音频: ${hasAudio}`, 'success');

                    // 模拟发送数据
                    const audioData = new Int16Array(dataLength);
                    for (let i = 0; i < dataLength; i++) {
                        audioData[i] = Math.random() * 32767; // 模拟音频数据
                    }
                    const audioBytes = new Uint8Array(audioData.buffer);
                    const audioHex = Array.from(audioBytes).map(b => b.toString(16).padStart(2, '0')).join('');

                    document.getElementById('audio-data-info').innerHTML =
                        `<div class="status info">
                            最新音频数据:<br>
                            样本数: ${audioData.length}<br>
                            字节数: ${audioBytes.length}<br>
                            十六进制长度: ${audioHex.length}<br>
                            最大振幅: ${maxAmplitude.toFixed(6)}
                        </div>`;

                    log(`📡 模拟发送数据 - 样本: ${audioData.length}, 字节: ${audioBytes.length}`, 'info');
                }
            }
        }

        // 停止音频测试
        function stopVoiceTest() {
            isVoiceTestActive = false;
            const btn = document.getElementById('voiceTestBtn');
            btn.textContent = '开始音频采集测试';

            if (audioProcessor) {
                if (audioProcessor.disconnect) {
                    audioProcessor.disconnect();
                }
                audioProcessor = null;
            }

            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            document.getElementById('volumeLevel').style.width = '0%';
            setStatus('voice-test-status', '音频采集测试已停止', 'info');
            log('音频采集测试已停止', 'info');
        }

        // 初始化
        window.onload = function() {
            log('🎤 麦克风诊断工具启动', 'success');
            detectBrowserInfo();
            detectAPISupport();
        };

        // 页面关闭时清理资源
        window.onbeforeunload = function() {
            stopVoiceTest();
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
            }
        };
    </script>
</body>
</html>
