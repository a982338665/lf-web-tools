<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬ç½‘ç«¯å£æ£€æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            font-size: 14px;
            overflow-x: auto;
        }

        .container {
            position: fixed;
            top: 0px;
            left: 6px;
            right: 6px;
            bottom: 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        h1::before {
            content: "ğŸ”";
            margin-right: 15px;
        }

        .main-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 420px 1fr;
            grid-template-rows: 1fr;
            grid-template-areas:
                "config right";
            gap: 15px;
            min-height: 0;
        }

        .right-panel {
            grid-area: right;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* å·¦ä¾§é…ç½®åŒºåŸŸ */
        .config-panel {
            grid-area: config;
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .config-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            height: 30px;
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .ports-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ports-input {
            flex: 1;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        .port-shortcuts {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .port-shortcut {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .port-shortcut:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .port-shortcut.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .scan-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-shrink: 0;
        }

        .scan-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
            transition: all 0.3s;
        }

        .scan-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .scan-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* å³ä¸Šç»“æœåŒºåŸŸ */
        .result-area {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 2;
            min-height: 0;
        }

        /* å³ä¸‹æ—¥å¿—åŒºåŸŸ */
        .log-area {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-height: 0;
            max-height: 250px;
        }

        .panel-header {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            height: 30px;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .panel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .panel-btn:hover {
            background: #5a6268;
        }

        .panel-btn.save {
            background: #28a745;
        }

        .panel-btn.save:hover {
            background: #218838;
        }

        .panel-btn.clear {
            background: #dc3545;
        }

        .panel-btn.clear:hover {
            background: #c82333;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .result-content {
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            min-height: 0;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            min-height: 0;
            max-height: 100%;
            word-wrap: break-word;
        }

        .log-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            background: #ffffff;
            border-left: 3px solid #6c757d;
        }

        .log-message.info {
            border-left-color: #17a2b8;
            background: #e7f3ff;
        }

        .log-message.success {
            border-left-color: #28a745;
            background: #eaf5ea;
        }

        .log-message.warning {
            border-left-color: #ffc107;
            background: #fff8e1;
        }

        .log-message.error {
            border-left-color: #dc3545;
            background: #ffeaea;
        }

        .log-time {
            color: #666;
            font-size: 0.9em;
            margin-right: 8px;
        }

        .log-type {
            font-weight: bold;
            margin-right: 8px;
            text-transform: uppercase;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s;
            width: 0%;
        }

        .status-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }

        .status-card.open {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status-card.closed {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .status-card.timeout {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .status-card.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .status-count {
            font-size: 18px;
            font-weight: bold;
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                grid-template-areas:
                    "config"
                    "right";
            }

            .right-panel {
                min-height: 600px;
            }

            .result-area {
                flex: 2;
            }

            .log-area {
                flex: 1;
                max-height: 200px;
            }

            .config-panel {
                max-height: none;
            }

            .port-shortcuts {
                grid-template-columns: repeat(4, 1fr);
                max-height: 120px;
            }

            .status-summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .port-shortcuts {
                grid-template-columns: repeat(3, 1fr);
            }

            .status-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å…¬ç½‘ç«¯å£æ£€æµ‹</h1>

        <div class="main-layout">
            <!-- å·¦ä¾§é…ç½®åŒºåŸŸ -->
            <div class="config-panel">
                <div class="config-section">
                    <div class="section-title">âš™ï¸ æ‰«æé…ç½®</div>

                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡IPåœ°å€</label>
                        <input type="text" class="form-input" id="hostInput" placeholder="è¯·è¾“å…¥IPåœ°å€ï¼Œä¾‹å¦‚ï¼š8.8.8.8" value="115.190.5.236">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ‰«æèŒƒå›´</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="scanType" value="all" id="scanAll">
                                <span>å…¨ç«¯å£ (1-65535)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="scanType" value="custom" id="scanCustom" checked>
                                <span>è‡ªå®šä¹‰</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="customPortsGroup">
                        <label class="form-label">ç«¯å£åˆ—è¡¨ (ç”¨é€—å·åˆ†éš”ï¼ŒèŒƒå›´æŸ¥è¯¢ç”¨ [-]ï¼Œä¾‹ï¼š8000-9000 )</label>
                        <div class="ports-input-group">
                            <input type="text" class="form-input ports-input" id="portsInput"
                                   placeholder="ä¾‹å¦‚ï¼š22,80,443,8080 æˆ– 8000-9000" value="8000-8099,80,3306,6379">
                            <button class="clear-btn" onclick="clearPorts()">æ¸…ç©º</button>
                        </div>

                        <div class="port-shortcuts" id="portShortcuts">
                            <div class="port-shortcut" data-port="80" data-name="nginx">nginx:80</div>
                            <div class="port-shortcut" data-port="8080" data-name="tomcat">tomcat:8080</div>
                            <div class="port-shortcut" data-port="22" data-name="ssh">ssh:22</div>
                            <div class="port-shortcut" data-port="6379" data-name="redis">redis:6379</div>
                            <div class="port-shortcut" data-port="27017" data-name="mongodb">mongodb:27017</div>
                            <div class="port-shortcut" data-port="3306" data-name="mysql">mysql:3306</div>
                            <div class="port-shortcut" data-port="5432" data-name="pgsql">pgsql:5432</div>
                            <div class="port-shortcut" data-port="1521" data-name="oracle">oracle:1521</div>
                            <div class="port-shortcut" data-port="5236" data-name="dameng">dameng:5236</div>
                            <div class="port-shortcut" data-port="1433" data-name="sqlserver">sqlserver:1433</div>
                            <div class="port-shortcut" data-port="9200" data-name="elasticsearch">elasticsearch:9200</div>
                            <div class="port-shortcut" data-port="9092" data-name="kafka">kafka:9092</div>
                            <div class="port-shortcut" data-port="5672" data-name="rabbitmq">rabbitmq:5672</div>
                            <div class="port-shortcut" data-port="9876" data-name="rocketmq">rocketmq:9876</div>
                            <div class="port-shortcut" data-port="61616" data-name="activemq">activemq:61616</div>
                            <div class="port-shortcut" data-port="2181" data-name="zookeeper">zookeeper:2181</div>
                            <div class="port-shortcut" data-port="5601" data-name="kibana">kibana:5601</div>
                            <div class="port-shortcut" data-port="8500" data-name="consul">consul:8500</div>
                        </div>
                    </div>

                    <div class="scan-controls">
                        <button class="scan-btn" id="scanBtn" onclick="startScan()">ğŸš€ å¼€å§‹æ‰«æ</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <!-- å³ä¸Šç»“æœåŒºåŸŸ -->
                <div class="result-area">
                    <div class="panel-header">
                        <div class="panel-title">ğŸ“Š æ‰«æç»“æœ</div>
                        <div class="panel-actions">
                            <button class="panel-btn save" onclick="saveResult()">ä¿å­˜</button>
                            <button class="panel-btn clear" onclick="clearResult()">æ¸…ç©º</button>
                        </div>
                    </div>

                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <div class="status-summary" id="statusSummary" style="display: none;">
                        <div class="status-card open">
                            <span class="status-count" id="openCount">0</span>
                            å¼€æ”¾
                        </div>
                        <div class="status-card closed">
                            <span class="status-count" id="closedCount">0</span>
                            å…³é—­
                        </div>
                        <div class="status-card timeout">
                            <span class="status-count" id="timeoutCount">0</span>
                            è¶…æ—¶
                        </div>
                        <div class="status-card error">
                            <span class="status-count" id="errorCount">0</span>
                            é”™è¯¯
                        </div>
                    </div>

                    <div class="result-content" id="resultContent">
                        ç‚¹å‡»"å¼€å§‹æ‰«æ"å¼€å§‹ç«¯å£æ£€æµ‹...
                    </div>
                </div>

                <!-- å³ä¸‹æ—¥å¿—åŒºåŸŸ -->
                <div class="log-area">
                    <div class="panel-header">
                        <div class="panel-title">ğŸ“ æ‰«ææ—¥å¿—</div>
                        <div class="panel-actions">
                            <button class="panel-btn" id="autoScrollBtn" onclick="toggleAutoScroll()">ğŸ“œ è‡ªåŠ¨æ»šåŠ¨</button>
                            <button class="panel-btn save" onclick="saveLog()">ä¿å­˜</button>
                            <button class="panel-btn clear" onclick="clearLog()">æ¸…ç©º</button>
                        </div>
                    </div>

                    <div class="log-content" id="logContent">
                        <!-- æ—¥å¿—å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoScroll = true;
        let isScanning = false;
        let selectedPorts = new Set();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initPortShortcuts();
            initScanTypeToggle();
            logMessage('info', 'ç«¯å£æ‰«æå·¥å…·åˆå§‹åŒ–å®Œæˆ');
        });

        // åˆå§‹åŒ–ç«¯å£å¿«æ·æ–¹å¼
        function initPortShortcuts() {
            const shortcuts = document.querySelectorAll('.port-shortcut');
            shortcuts.forEach(shortcut => {
                shortcut.addEventListener('click', function() {
                    const port = this.getAttribute('data-port');
                    const name = this.getAttribute('data-name');
                    togglePortSelection(port, name, this);
                });
            });
        }

        // åˆå§‹åŒ–æ‰«æç±»å‹åˆ‡æ¢
        function initScanTypeToggle() {
            const scanAll = document.getElementById('scanAll');
            const scanCustom = document.getElementById('scanCustom');
            const customPortsGroup = document.getElementById('customPortsGroup');

            scanAll.addEventListener('change', function() {
                if (this.checked) {
                    customPortsGroup.style.display = 'none';
                }
            });

            scanCustom.addEventListener('change', function() {
                if (this.checked) {
                    customPortsGroup.style.display = 'block';
                }
            });
        }

        // åˆ‡æ¢ç«¯å£é€‰æ‹©
        function togglePortSelection(port, name, element) {
            const portsInput = document.getElementById('portsInput');
            let currentPorts = portsInput.value.trim();

            if (selectedPorts.has(port)) {
                // ç§»é™¤ç«¯å£
                selectedPorts.delete(port);
                element.classList.remove('selected');

                // ä»è¾“å…¥æ¡†ä¸­ç§»é™¤
                const portsArray = currentPorts.split(',').map(p => p.trim()).filter(p => p !== '' && p !== port);
                portsInput.value = portsArray.join(',');

                logMessage('info', `å·²ç§»é™¤ç«¯å£: ${port} (${name})`);
            } else {
                // æ·»åŠ ç«¯å£
                selectedPorts.add(port);
                element.classList.add('selected');

                // æ·»åŠ åˆ°è¾“å…¥æ¡†
                if (currentPorts === '') {
                    portsInput.value = port;
                } else {
                    portsInput.value = currentPorts + ',' + port;
                }

                logMessage('info', `å·²æ·»åŠ ç«¯å£: ${port} (${name})`);
            }
        }

        // æ¸…ç©ºç«¯å£
        function clearPorts() {
            document.getElementById('portsInput').value = '';
            selectedPorts.clear();

            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.port-shortcut.selected').forEach(el => {
                el.classList.remove('selected');
            });

            logMessage('info', 'å·²æ¸…ç©ºæ‰€æœ‰ç«¯å£');
        }

        // å¼€å§‹æ‰«æ
        async function startScan() {
            const hostInput = document.getElementById('hostInput');
            const portsInput = document.getElementById('portsInput');
            const scanAll = document.getElementById('scanAll');
            const scanBtn = document.getElementById('scanBtn');

            let host = hostInput.value.trim();
            if (!host) {
                host = '115.190.5.236';
                hostInput.value = host;
                logMessage('info', 'ä½¿ç”¨é»˜è®¤IPåœ°å€: 115.190.5.236');
            }

            // IPåœ°å€æ ¼å¼éªŒè¯
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipRegex.test(host)) {
                logMessage('error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€æ ¼å¼');
                return;
            }

            let ports = '';
            let scanAllPorts = scanAll.checked;

            if (!scanAllPorts) {
                ports = portsInput.value.trim();
                if (!ports) {
                    ports = '8000-8099,80,3306,6379';
                    portsInput.value = ports;
                    logMessage('info', 'ä½¿ç”¨é»˜è®¤ç«¯å£: 8000-8099,80,3306,6379');
                }
            }

            // å¼€å§‹æ‰«æ
            isScanning = true;
            scanBtn.disabled = true;
            scanBtn.textContent = 'â³ æ‰«æä¸­...';

            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            logMessage('info', `å¼€å§‹æ‰«æä¸»æœº: ${host}`);
            if (scanAllPorts) {
                logMessage('info', 'æ‰«æç±»å‹: å…¨ç«¯å£ (1-65535)');
            } else {
                logMessage('info', `æ‰«æç«¯å£: ${ports}`);
            }

            try {
                const response = await fetch('/port-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: host,
                        ports: ports,
                        scanAll: scanAllPorts,
                        timeout: 8000,
                        batchSize: 20
                    })
                });

                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('æ”¶åˆ°æ‰«æç»“æœ:', result);
                logMessage('info', 'æ”¶åˆ°æ‰«æå“åº”ï¼Œæ­£åœ¨å¤„ç†ç»“æœ...');
                displayScanResult(result);
                logMessage('success', 'æ‰«æå®Œæˆ');

            } catch (error) {
                logMessage('error', `æ‰«æå¤±è´¥: ${error.message}`);
                document.getElementById('resultContent').textContent = `æ‰«æå¤±è´¥: ${error.message}`;
            } finally {
                isScanning = false;
                scanBtn.disabled = false;
                scanBtn.textContent = 'ğŸš€ å¼€å§‹æ‰«æ';
                progressBar.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ‰«æç»“æœ
        function displayScanResult(result) {
            const resultContent = document.getElementById('resultContent');
            const statusSummary = document.getElementById('statusSummary');

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('openCount').textContent = result.openPorts ? result.openPorts.length : 0;
            document.getElementById('closedCount').textContent = result.closedPorts ? result.closedPorts.length : 0;
            document.getElementById('timeoutCount').textContent = result.timeoutPorts ? result.timeoutPorts.length : 0;
            document.getElementById('errorCount').textContent = result.errorPorts ? result.errorPorts.length : 0;

            statusSummary.style.display = 'grid';

            // æ„å»ºç»“æœæ˜¾ç¤º
            let resultText = '';
            resultText += `æ‰«æä¸»æœº: ${result.host}\n`;
            resultText += `æ‰«ææ—¶é—´: ${result.startTime} - ${result.endTime}\n`;
            resultText += `æ‰«æè€—æ—¶: ${result.duration}\n`;
            resultText += `æ€»è®¡ç«¯å£: ${result.totalScanned}\n`;
            resultText += `=========================================\n\n`;

            if (result.openPorts && result.openPorts.length > 0) {
                resultText += `ğŸŸ¢ å¼€æ”¾ç«¯å£ (${result.openPorts.length} ä¸ª):\n`;
                resultText += `${result.openPorts.join(', ')}\n\n`;
            }

            if (result.closedPorts && result.closedPorts.length > 0) {
                resultText += `ğŸ”´ å…³é—­ç«¯å£ (${result.closedPorts.length} ä¸ª):\n`;
                if (result.closedPorts.length > 50) {
                    resultText += `${result.closedPorts.slice(0, 50).join(', ')}... (ä»…æ˜¾ç¤ºå‰50ä¸ª)\n\n`;
                } else {
                    resultText += `${result.closedPorts.join(', ')}\n\n`;
                }
            }

            if (result.timeoutPorts && result.timeoutPorts.length > 0) {
                resultText += `â° è¶…æ—¶ç«¯å£ (${result.timeoutPorts.length} ä¸ª):\n`;
                if (result.timeoutPorts.length > 50) {
                    resultText += `${result.timeoutPorts.slice(0, 50).join(', ')}... (ä»…æ˜¾ç¤ºå‰50ä¸ª)\n\n`;
                } else {
                    resultText += `${result.timeoutPorts.join(', ')}\n\n`;
                }
            }

            if (result.errorPorts && result.errorPorts.length > 0) {
                resultText += `âŒ é”™è¯¯ç«¯å£ (${result.errorPorts.length} ä¸ª):\n`;
                if (result.errorPorts.length > 50) {
                    resultText += `${result.errorPorts.slice(0, 50).join(', ')}... (ä»…æ˜¾ç¤ºå‰50ä¸ª)\n\n`;
                } else {
                    resultText += `${result.errorPorts.join(', ')}\n\n`;
                }
            }

            resultContent.textContent = resultText;

            // è®°å½•è¯¦ç»†æ—¥å¿—
            const openCount = result.openPorts ? result.openPorts.length : 0;
            const closedCount = result.closedPorts ? result.closedPorts.length : 0;
            const timeoutCount = result.timeoutPorts ? result.timeoutPorts.length : 0;
            const errorCount = result.errorPorts ? result.errorPorts.length : 0;

            logMessage('success', `æ‰«æå®Œæˆ - å¼€æ”¾: ${openCount}, å…³é—­: ${closedCount}, è¶…æ—¶: ${timeoutCount}, é”™è¯¯: ${errorCount}`);
            logMessage('info', `æ€»è€—æ—¶: ${result.duration}`);
        }

        // è®°å½•æ—¥å¿—æ¶ˆæ¯
        function logMessage(type, message) {
            const logContent = document.getElementById('logContent');
            const logDiv = document.createElement('div');
            logDiv.className = `log-message ${type}`;

            const timestamp = new Date().toLocaleTimeString();

            logDiv.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-type">${type.toUpperCase()}</span>
                ${message}
            `;

            logContent.appendChild(logDiv);

            // é™åˆ¶æ—¥å¿—æ•°é‡
            const maxLogs = 500;
            const allLogs = logContent.querySelectorAll('.log-message');
            if (allLogs.length > maxLogs) {
                allLogs[0].remove();
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (autoScroll) {
                scrollToBottom();
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const logContent = document.getElementById('logContent');
            // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°åå†æ»šåŠ¨
            setTimeout(() => {
                logContent.scrollTop = logContent.scrollHeight;
            }, 10);
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.textContent = autoScroll ? 'ğŸ“œ è‡ªåŠ¨æ»šåŠ¨' : 'ğŸ“œ æ‰‹åŠ¨æ»šåŠ¨';

            if (autoScroll) {
                scrollToBottom();
            }

            logMessage('info', `è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        }

        // ä¿å­˜ç»“æœ
        function saveResult() {
            const resultContent = document.getElementById('resultContent');
            const content = `ç«¯å£æ‰«æç»“æœ - ${new Date().toLocaleString()}\n${'='.repeat(50)}\n\n${resultContent.textContent}`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `port-scan-result-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logMessage('info', 'æ‰«æç»“æœå·²ä¿å­˜');
        }

        // ä¿å­˜æ—¥å¿—
        function saveLog() {
            const logMessages = document.querySelectorAll('.log-message');
            let logContent = `ç«¯å£æ‰«ææ—¥å¿— - ${new Date().toLocaleString()}\n${'='.repeat(50)}\n\n`;

            logMessages.forEach(msg => {
                logContent += msg.textContent + '\n';
            });

            const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `port-scan-log-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logMessage('info', 'æ‰«ææ—¥å¿—å·²ä¿å­˜');
        }

        // æ¸…ç©ºç»“æœ
        function clearResult() {
            document.getElementById('resultContent').textContent = 'ç‚¹å‡»"å¼€å§‹æ‰«æ"å¼€å§‹ç«¯å£æ£€æµ‹...';
            document.getElementById('statusSummary').style.display = 'none';
            logMessage('info', 'æ‰«æç»“æœå·²æ¸…ç©º');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            logMessage('info', 'æ‰«ææ—¥å¿—å·²æ¸…ç©º');
        }
    </script>
</body>
</html>
